# モニタリング（監視）戦略

## 1. 目的
- モダンアプリケーションのモニタリング戦略についての整理事項をまとめる

## 2. モニタリングについて

### 2.1. モニタリング（監視）の目的
1. 異常を検知して復旧させるため
2. 定期的・継続的に観測することでシステムの価値を維持・向上させるために行う

### 2.2. モニタリングデータ例
#### ビジネスデータ
- ビジネスの状況を可視化するために必要なデータ
  - アクティブなユーザー数
  - 会員数
  - 閲覧数、検索数
  - 滞在時間
- 経営戦略、マーケティング効果の計測などに利用する
- ビジネスプランに応じて取得すべきデータが異なる

#### 運用データ
- サービスの運用状況を可視化するデータ
  - 運用担当者の呼び出し回数
  - 設定変更など運用作業の依頼として起票されたチケットの数
  - チケットが完了するまでの経過時間
  - 1回あたりのデプロイ数
  - サービス可用性
- ビジネスデータと異なり、多くのチームで同じような観点が用いられる

#### システムデータ
- サービスが実行されているインフラやアプリの状況を可視化するデータ
  - REDメソッド: リクエスト駆動サービスで効果的
    - リクエスト数(Rate)
    - リクエストのエラー数(Errors)
    - リクエストの処理時間(Duration)
  - USEメソッド：キュー駆動サービスで効果的
    - タスクの処理件数(Utilization)
    - キューイングされているタスクの件数(Saturation)
    - エラー件数(Errors)
  - リソースの状況を可視化するメトリクス
    - REDメソッドやUSEメソッドで何かしら問題を検知した場合に調査するデータ
    - CPU利用率
    - メモリ利用率
    - ネットワークI/O
    - マネージドサービスが提供するメトリクス

### 2.3. モニタリングシステムの構成
#### 2.3.1. 観測
- CloudWatch エージェント

#### 2.3.2. データ収集
- CloudWatch Metrics
- CloudWatch Logs

#### 2.3.3. データの利用
- メトリクスに応じたアクション
  - CloudWatch Alarms → SNS Topic → SMS
- logの可視化
  - CloudWatch Logs Insights
  - CloudWatch Dashboards

## 3. 考え方整理
- 監視計画を立てる（ツールの選定は監視計画と合わせて検討する）
  - モニタリングの目的は何か？
  - 対象のリソースは何か？
  - どのくらいの頻度で監視するか？
  - 誰が監視するか？
  - どんなツールで監視するか？
  - 通知は誰が受け取るか？
- 監視データの分類と対応パターンを定義する
- 不具合発生時以外でも、定期的に監視を継続し、システムメンテに生かす
- お金をかけずなるべくマネージドサービスを利用する（CloudWatch）

## 4. ユースケース例
- ケース：エラーログと障害解析
  - 障害発生時に管理者がアラートを受け取る。担当者に連絡する
  - 担当者は障害原因調査、対策を行う
  - 検証環境で健全性確認後、対策版のリリースを行う
- ケース：ユーザー行動分析
  - 運用者が管理者に知りたい情報の提供依頼をする（、ページビュー、クリック数、コンバージョン率）。
  - 担当者がメトリクスをファイルに出力し提供する
- ケース：セキュリティ監視
  - ログイン試行、アクセス制御の違反、異常なデータアクセスを検知し、通知する
  - 対応措置を講じる
- ケース：インフラ
  - リソースの使用状況、ネットワークのトラフィック、ディスクの容量などを収集する
  - インフラストラクチャの健全性や負荷状況を把握する
  - スケーラビリティの評価や適切なリソース割り当ての決定を行う
- ケース：データの品質担保
  - データの正確性、一貫性、完全性を監視する
  - データの信頼性を高め、データ駆動の意思決定やレポート作成において正確な情報を提供する


## 参考資料
- AWSで実現するモダンプリケーション入門 落水恭介, 吉田慶章 著
- https://logmi.jp/tech/articles/326744
